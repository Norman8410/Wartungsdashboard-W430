<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>BOSCH W430 - Central Cockpit V1.2</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --bosch-red: #d50000; --bosch-dark-red: #8b0000; --bosch-blue: #003a6c; --bosch-green: #008a4f; --bosch-gray: #eff1f2; --bosch-orange: #ffa500; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Drawer Menu */
        .nav-drawer { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: white; box-shadow: 2px 0 15px rgba(0,0,0,0.3); transition: 0.3s ease-in-out; z-index: 3000; padding-top: 20px; }
        .nav-drawer.open { left: 0; }
        .drawer-header { padding: 20px; border-bottom: 2px solid var(--bosch-gray); margin-bottom: 10px; }
        .nav-item { padding: 15px 25px; display: flex; align-items: center; color: #404040; text-decoration: none; font-weight: 600; border-bottom: 1px solid #f0f0f0; transition: 0.2s; }
        .nav-item:hover { background: #f8f9fa; color: var(--bosch-blue); }
        .nav-item.active { border-left: 5px solid var(--bosch-red); background: #fdfdfd; color: var(--bosch-red); }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2500; backdrop-filter: blur(2px); }

        .top-bar { height: 45px; background: linear-gradient(90deg, #d50000 0%, #d50000 25%, #003a6c 25%, #003a6c 50%, #00b5e2 50%, #00b5e2 75%, #008a4f 75%, #008a4f 100%); display: flex; align-items: center; padding: 0 15px; color: white; font-weight: bold; }
        .header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .bosch-text { color: #d50000; font-size: 26px; font-weight: 900; letter-spacing: -1px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; padding: 20px; flex: 1; overflow: hidden; }
        .col { background: #fdfdfd; border-radius: 5px; display: flex; flex-direction: column; border-top: 8px solid #ccc; box-shadow: 0 4px 10px rgba(0,0,0,0.06); }
        .col-header { padding: 12px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; color: white; }
        .col-content { padding: 12px; overflow-y: auto; flex: 1; }
        
        .card { background: white; border: 1px solid #ddd; padding: 12px; margin-bottom: 10px; border-left: 10px solid #ccc; border-radius: 3px; position: relative; }
        .card-id { font-size: 18px; font-weight: bold; color: var(--bosch-blue); }
        .card-rest { font-size: 16px; font-weight: 900; float: right; }
        .assign-area { margin-top: 10px; padding-top: 5px; border-top: 1px solid #eee; font-size: 12px; display: flex; justify-content: space-between; align-items: center;}
        
        .crit { border-left-color: var(--bosch-dark-red); background: #fff8f8; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .warn { border-left-color: var(--bosch-orange); }
        
        button.assign-btn { background: #eee; border: 1px solid #ccc; cursor: pointer; padding: 2px 8px; font-size: 11px; border-radius: 3px; }
        button.assign-btn:hover { background: #ddd; }
    </style>
</head>
<body>
    
    <div id="drawerOverlay" class="overlay" onclick="toggleMenu()"></div>
    <div id="navDrawer" class="nav-drawer">
        <div class="drawer-header"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/16/Bosch-logo.svg/1024px-Bosch-logo.svg.png" width="120" alt="Bosch"></div>
        <a href="index.html" class="nav-item active">üè† Dashboard (Aktiv)</a>
        <a href="https://norman8410.github.io/agie-wartung/" class="nav-item">‚ö° Agie Wartung</a>
        <a href="https://norman8410.github.io/unotron-wartung/" class="nav-item">üß™ Unotron</a>
        <a href="https://norman8410.github.io/HE-Wartung/" class="nav-item">‚öôÔ∏è HE Wartung</a>
        <div style="position: absolute; bottom: 20px; left: 25px; font-size: 11px; color: #999;">Verantwortlich: Norman Schultheis</div>
    </div>

    <div class="top-bar">
        <span style="font-size:24px; cursor:pointer; margin-right:15px;" onclick="toggleMenu()">‚ò∞</span>
        BOSCH W430 MAINTENANCE CONTROL
    </div>
    
    <div class="grid">
        <div class="col" style="border-top-color: var(--bosch-blue)">
            <div class="col-header" style="background: var(--bosch-blue)">‚ö° AGIE (Warnung/Kritisch) <span id="cAgie">0</span></div>
            <div id="lAgie" class="col-content"></div>
        </div>
        
        <div class="col" style="border-top-color: var(--bosch-green)">
            <div class="col-header" style="background: var(--bosch-green)">üß™ UNOTRON (Warnung/Kritisch) <span id="cUno">0</span></div>
            <div id="lUno" class="col-content"></div>
        </div>
        
        <div class="col" style="border-top-color: var(--bosch-dark-red)">
            <div class="col-header" style="background: var(--bosch-red)">‚öôÔ∏è HE (Warnung/Kritisch) <span id="cHe">0</span></div>
            <div id="lHe" class="col-content"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg",
            authDomain: "bosch-agie-wartung.firebaseapp.com",
            databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bosch-agie-wartung",
            storageBucket: "bosch-agie-wartung.firebasestorage.app",
            messagingSenderId: "211606405555",
            appId: "1:211606405555:web:cc2475ca47804086a3cbc6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let configData = {};
        db.ref('config').on('value', snap => { configData = snap.val() || {}; });

        const INT_AGIE = 16000;
        const INT_HE = 156000;
        const UNO_STEPS = [2000, 4000, 10000, 14000, 18000, 26000, 28000, 30000, 34000, 42000, 50000, 56000, 58000, 66000, 74000, 82000, 90000, 98000, 104000];
        
        function toggleMenu() { document.getElementById('navDrawer').classList.toggle('open'); document.getElementById('drawerOverlay').style.display = document.getElementById('navDrawer').classList.contains('open') ? 'block' : 'none'; }

        async function assignPerson(path, id) {
            if(!configData.TelPW) return alert("Konfiguration wird noch geladen...");
            const name = prompt("Name des Verantwortlichen eingeben:");
            if(!name) return;
            const pw = prompt("Bitte Telefon-Passwort (TelPW) eingeben zur Best√§tigung:");
            if(pw === configData.TelPW) {
                await db.ref(path + '/assignments/' + id).set({ name: name, time: new Date().toLocaleString() });
                alert("Gespeichert!");
            } else {
                alert("Falsches Passwort!");
            }
        }

        async function load() {
            const [sA, sH, sU] = await Promise.all([
                db.ref('maintenanceState').once('value'),
                db.ref('maintenanceStateHE').once('value'),
                db.ref('maintenanceStateUnotron').once('value')
            ]);

            const buildList = (snap, pathName, interval, warnLimit) => {
                let html = "", count = 0;
                const d = snap.val() || {};
                const assigns = d.assignments || {};
                
                (d.cloudRawData || []).forEach(m => {
                    const id = m.StationNo || m.STATIONNO;
                    const ist = (parseInt(m.Parts || m.PARTS || m['COUNT(*)']) || 0) + ((d.manualOffsets || {})[id] || 0) - ((d.agieOffsets || {})[id] || 0);
                    const c = (d.extraCycles || {})[id] || 0;
                    
                    let target, prev = 0;
                    if(Array.isArray(interval)) { 
                        prev = c > 0 ? interval[c-1] : 0; target = interval[c] || 104000; 
                    } else { 
                        target = (c + 1) * interval; prev = c * interval; 
                    }
                    
                    const rest = target - ist;
                    let status = null;
                    if (rest <= 0) status = 'crit';
                    else if (rest < warnLimit) status = 'warn';

                    if (status) {
                        count++;
                        const assignee = assigns[id] ? `<span style="color:#008a4f">üë∑ ${assigns[id].name}</span>` : `<span style="color:#999">Niemand</span>`;
                        html += `
                        <div class="card ${status}">
                            <div class="card-rest">${rest.toLocaleString()}</div>
                            <div class="card-id">#${id}</div>
                            <div class="assign-area">
                                ${assignee}
                                <button class="assign-btn" onclick="assignPerson('${pathName}', '${id}')">Bearbeiten</button>
                            </div>
                        </div>`;
                    }
                });
                return { html, count };
            };

            // Limits: Agie < 2000 (Warn), HE < 15000 (Warn), Unotron < 2000 (Warn)
            const agieRes = buildList(sA, 'maintenanceState', INT_AGIE, 2000);
            const heRes = buildList(sH, 'maintenanceStateHE', INT_HE, 15000);
            const unoRes = buildList(sU, 'maintenanceStateUnotron', UNO_STEPS, 2000);

            document.getElementById('lAgie').innerHTML = agieRes.html; document.getElementById('cAgie').innerText = agieRes.count;
            document.getElementById('lHe').innerHTML = heRes.html; document.getElementById('cHe').innerText = heRes.count;
            document.getElementById('lUno').innerHTML = unoRes.html; document.getElementById('cUno').innerText = unoRes.count;
        }
        
        // Live Reload alle 10s und initial
        load(); setInterval(load, 10000);
    </script>
</body>
</html>
