<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Zentral-Dashboard Wartung - Bosch</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --bosch-red: #d50000; --bosch-blue: #003a6c; --bosch-light-blue: #00b5e2; 
            --bosch-green: #008a4f; --bosch-gray: #eff1f2; --bosch-dark-red: #8b0000;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .top-bar { height: 10px; background: linear-gradient(90deg, #d50000 0%, #d50000 25%, #003a6c 25%, #003a6c 50%, #00b5e2 50%, #00b5e2 75%, #008a4f 75%, #008a4f 100%); }
        .header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; padding: 20px; flex: 1; overflow: hidden; }
        .column { background: white; border-top: 5px solid var(--bosch-blue); display: flex; flex-direction: column; overflow: hidden; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .col-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 1.2em; display: flex; justify-content: space-between; align-items: center; }
        .col-header a { text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        .machine-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .card { padding: 12px; border-bottom: 1px solid #eee; border-left: 8px solid #ccc; margin-bottom: 8px; background: #fff; }
        .card.warning { border-left-color: #ffa500; }
        .card.critical { border-left-color: var(--bosch-red); animation: pulse 2s infinite; }
        .card.overdue { border-left-color: var(--bosch-dark-red); animation: pulse 1s infinite; }
        
        .card-info { display: flex; justify-content: space-between; align-items: flex-start; }
        .m-id { font-weight: bold; font-size: 1.1em; }
        .m-rest { font-weight: bold; font-size: 1.1em; }
        .m-paket { font-size: 0.85em; color: var(--bosch-red); font-weight: 600; margin-top: 2px; }
        
        select { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 2px; margin-top: 8px; }
        .nav-btn { padding: 8px 15px; cursor: pointer; border: 1px solid #ccc; background: white; font-weight: bold; color: var(--bosch-blue); border-radius: 2px; font-size: 13px; }
        .btn-primary { background: var(--bosch-blue); color: white; border: none; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 4000; }
        .modal-box { background: white; padding: 30px; border-top: 8px solid var(--bosch-red); width: 450px; text-align: left; border-radius: 4px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; box-sizing: border-box; }
        
        @keyframes pulse { 0% { background: #fff; } 50% { background: #fff0f0; } 100% { background: #fff; } }
    </style>
</head>
<body>

<div class="top-bar"></div>
<div class="header">
    <div>
        <span style="color:var(--bosch-red);font-weight:900;font-size:24px;">BOSCH</span> 
        <span style="font-weight:bold;color:#555;margin-left:10px;">Zentral-Dashboard</span>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="nav-btn" onclick="openHelpModal()">‚ÑπÔ∏è Hilfe</button>
        <button class="nav-btn" onclick="exportAuditLog()">üìä CSV Export</button>
        <button id="authBtn" class="nav-btn" onclick="openLoginModal()">üîë Login</button>
        <button class="nav-btn" onclick="openAdminModal()">‚öôÔ∏è Einsteller</button>
    </div>
</div>

<div class="dashboard-grid">
    <div class="column">
        <div class="col-header"><a href="https://norman8410.github.io/agie-wartung/" target="_blank">‚ö° Agie ‚ûî</a> <span id="count-agie">0</span></div>
        <div class="machine-list" id="list-agie"></div>
    </div>
    <div class="column" style="border-top-color: var(--bosch-green);">
        <div class="col-header"><a href="https://norman8410.github.io/unotron-wartung/" target="_blank">üß™ Unotron ‚ûî</a> <span id="count-uno">0</span></div>
        <div class="machine-list" id="list-uno"></div>
    </div>
    <div class="column" style="border-top-color: var(--bosch-light-blue);">
        <div class="col-header"><a href="https://norman8410.github.io/HE-Wartung/" target="_blank">‚öôÔ∏è HE ‚ûî</a> <span id="count-he">0</span></div>
        <div class="machine-list" id="list-he"></div>
    </div>
</div>

<div id="loginModal" class="modal">
    <div class="modal-box" style="text-align: center;">
        <h3 id="mTitle">Login</h3>
        <input type="email" id="mEmail" placeholder="E-Mail">
        <input type="password" id="mPass" placeholder="Passwort">
        <div id="regExtra" style="display:none;">
            <input type="text" id="mInvite" placeholder="Einladungscode">
            <p style="font-size:11px;color:#666;">Den Einladungscode erhalten Sie von Ihrem TL, FK oder Admin.</p>
        </div>
        <button class="nav-btn btn-primary" style="width:100%;margin-top:10px;" onclick="handleAuthAction()">Best√§tigen</button>
        <p id="toggleT" style="cursor:pointer;color:var(--bosch-blue);font-size:12px;" onclick="toggleM()">Konto erstellen?</p>
        <button class="nav-btn" style="width:100%" onclick="closeModals()">Abbrechen</button>
    </div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-box">
        <h2 style="color:var(--bosch-blue); border-bottom: 2px solid var(--bosch-red); padding-bottom: 10px; margin-top: 0;">System-Anleitung</h2>
        <div style="font-size: 0.9em; line-height: 1.4; color: #333; max-height: 350px; overflow-y: auto;">
            <p><strong>1. √úberwachung:</strong> Das Dashboard listet alle Maschinen, deren Wartung bald f√§llig ist. 
            <span style="color:orange; font-weight:bold;">Gelb</span> (Warnung), <span style="color:red; font-weight:bold;">Rot</span> (Kritisch).</p>
            <p><strong>2. Pakete:</strong> Unter der Maschinennummer wird das spezifisch f√§llige Paket (z.B. P1/2 oder P 6/7/12) angezeigt.</p>
            <p><strong>3. Einsteller-Zuweisung:</strong> Loggen Sie sich ein, um einen Einsteller f√ºr eine Maschine zu w√§hlen. Diese √Ñnderung erfordert zur Sicherheit das Admin-PW.</p>
            <p><strong>4. Audit-Log:</strong> Jede √Ñnderung wird f√ºr Audit-Zwecke protokolliert (Wer, Wann, Was). Der Export ist f√ºr Admins √ºber den CSV-Button m√∂glich.</p>
            <hr>
            <div style="background: #f8f9fa; padding: 10px; border-left: 4px solid var(--bosch-blue);">
                <strong>Systemverantwortlicher & Projektleiter:</strong><br>
                <span style="font-size: 1.1em; font-weight: bold;">Norman Schultheis</span><br>
                Ansprechpartner f√ºr Einladungscodes, Audit-Berichte und techn. Support.
            </div>
        </div>
        <button class="nav-btn btn-primary" style="width:100%; margin-top:20px;" onclick="closeModals()">Schlie√üen</button>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg", authDomain: "bosch-agie-wartung.firebaseapp.com", databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app", projectId: "bosch-agie-wartung" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();

    const AGIE_PKGS = ["P1/2", "P1/3", "P1/2", "P1/4", "P1/2/3", "P1/5", "P1/2", "P1/3", "P1/2", "P1/4", "P1/2/3", "P1/6/7", "P1/2"];
    const UNO_STEPS = [{total:2000, pkg:"P1, P2"}, {total:4000, pkg:"P3"}, {total:10000, pkg:"P1"}, {total:14000, pkg:"P5"}, {total:18000, pkg:"P1, P2"}, {total:26000, pkg:"P1"}, {total:28000, pkg:"P6, P7"}, {total:30000, pkg:"P3"}, {total:34000, pkg:"P1, P2"}, {total:42000, pkg:"P1"}, {total:50000, pkg:"P1, P2"}, {total:56000, pkg:"P3"}, {total:58000, pkg:"P1"}, {total:66000, pkg:"P1, P2"}, {total:74000, pkg:"P1"}, {total:82000, pkg:"P1, P2"}, {total:90000, pkg:"P3"}, {total:98000, pkg:"P1"}, {total:104000, pkg:"WP RESET"}];

    let state = { config:{}, assignments:{}, agie:{}, uno:{}, he:{} };
    let isReg = false;

    db.ref('config').on('value', s => { state.config = s.val() || {}; updateUI(); });
    db.ref('dashboardAssignments').on('value', s => { state.assignments = s.val() || {}; updateUI(); });
    db.ref('maintenanceState').on('value', s => { state.agie = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateUnotron').on('value', s => { state.uno = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateHE').on('value', s => { state.he = s.val() || {}; updateUI(); });

    auth.onAuthStateChanged(user => {
        document.getElementById('authBtn').innerText = user ? "üîì Logout" : "üîë Login";
        updateUI();
    });

    async function writeLog(action, machine, detail) {
        const user = auth.currentUser ? auth.currentUser.email : "Unbekannt";
        await db.ref('auditLog').push({ timestamp: new Date().toISOString(), user, action, machine, detail });
    }

    async function handleAuthAction() {
        const email = document.getElementById('mEmail').value, pass = document.getElementById('mPass').value;
        try {
            if(isReg) {
                if(document.getElementById('mInvite').value !== state.config.inviteCode) return alert("Code falsch!");
                await auth.createUserWithEmailAndPassword(email, pass);
            } else { await auth.signInWithEmailAndPassword(email, pass); }
            closeModals();
        } catch(e) { alert(e.message); }
    }

    async function safeSave(key, val) {
        if(!auth.currentUser) return alert("Bitte erst einloggen!");
        if(prompt("Admin Passwort zur Best√§tigung:") !== state.config.AdminPW) {
            alert("Code falsch!"); updateUI(); return;
        }
        await db.ref(`dashboardAssignments/${key}`).set(val);
        writeLog("Einsteller Zuweisung", key, `Neuer Einsteller: ${val}`);
    }

    async function exportAuditLog() {
        if(prompt("Admin Passwort f√ºr Export:") !== state.config.AdminPW) return alert("Keine Berechtigung!");
        const snapshot = await db.ref('auditLog').once('value');
        const logs = snapshot.val();
        if(!logs) return alert("Keine Daten.");
        let csv = "\ufeffZeitstempel;Benutzer;Aktion;Maschine;Details\n";
        Object.values(logs).forEach(l => { csv += `${l.timestamp};${l.user};${l.action};${l.machine};${l.detail}\n`; });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.setAttribute("download", `Wartung_Log_${new Date().toLocaleDateString()}.csv`);
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    function updateUI() {
        renderCol('list-agie', 'count-agie', state.agie, 'A', 2000, 500);
        renderCol('list-uno', 'count-uno', state.uno, 'U', 666, 166);
        renderCol('list-he', 'count-he', state.he, 'H', 15000, 5000);
    }

    function renderCol(id, cId, raw, pre, warn, crit) {
        if(!raw.cloudRawData) return;
        const data = raw.cloudRawData.map(item => {
            const sId = item.StationNo || item.STATIONNO;
            const cIdx = raw.extraCycles?.[sId] || 0;
            let ist, target, pkg;
            if(pre==='A') { 
                ist = (parseInt(item.Parts)||0) - (raw.agieOffsets?.[sId]||0); 
                target = 16000 + (cIdx * 16000);
                pkg = AGIE_PKGS[Math.min(cIdx, AGIE_PKGS.length-1)];
            } else if(pre==='U') {
                ist = parseInt(item["COUNT(*)"]||0);
                const tObj = UNO_STEPS[cIdx] || { total: 104000+((cIdx-18)*5000), pkg: "Folge" };
                target = tObj.total; pkg = tObj.pkg;
            } else {
                ist = (parseInt(item.Parts)||0) + (raw.manualOffsets?.[sId]||0);
                target = 156000 * (cIdx + 1);
                pkg = (cIdx % 4 === 0) ? "P 6/7/12" : "Wartung";
            }
            return { id:pre+sId, rest: target-ist, key:pre+sId, pkg };
        }).filter(m => m.rest < warn).sort((a,b) => a.rest - b.rest);

        document.getElementById(cId).innerText = data.length;
        document.getElementById(id).innerHTML = data.map(m => `
            <div class="card ${m.rest<=0?'overdue':(m.rest<crit?'critical':'warning')}">
                <div class="card-info">
                    <div><div class="m-id">${m.id}</div><div class="m-paket">${m.pkg}</div></div>
                    <div class="m-rest">${m.rest.toLocaleString()}</div>
                </div>
                <select ${!auth.currentUser?'disabled':''} onchange="safeSave('${m.key}', this.value)">
                    <option value="">-- Einsteller --</option>
                    ${(state.config.einstellerListe||[]).map(e => `<option value="${e}" ${state.assignments[m.key]===e?'selected':''}>${e}</option>`).join('')}
                </select>
            </div>`).join('');
    }

    function openHelpModal() { document.getElementById('helpModal').style.display='flex'; }
    function openLoginModal() { if(auth.currentUser) auth.signOut(); else document.getElementById('loginModal').style.display='flex'; }
    function closeModals() { document.getElementById('loginModal').style.display='none'; document.getElementById('helpModal').style.display='none'; }
    function toggleM() { isReg=!isReg; document.getElementById('regExtra').style.display=isReg?'block':'none'; }
    function openAdminModal() {
        if(prompt("Admin PW:") === state.config.AdminPW) {
            const nl = prompt("Einsteller (Komma getrennt):", (state.config.einstellerListe||[]).join(','));
            if(nl) db.ref('config/einstellerListe').set(nl.split(',').map(s=>s.trim()));
        }
    }
</script>
</body>
</html>
