<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>BOSCH W430 - Central Cockpit</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --bosch-red: #d50000; --bosch-dark-red: #8b0000; --bosch-blue: #003a6c; --bosch-green: #008a4f; --bosch-gray: #eff1f2; --bosch-orange: #ffa500; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .top-bar { height: 45px; background: linear-gradient(90deg, #d50000 0%, #d50000 25%, #003a6c 25%, #003a6c 50%, #00b5e2 50%, #00b5e2 75%, #008a4f 75%, #008a4f 100%); display: flex; align-items: center; padding: 0 15px; color: white; font-weight: bold; }
        .header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .bosch-text { color: #d50000; font-size: 26px; font-weight: 900; letter-spacing: -1px; }
        .nav-hub { display: flex; gap: 8px; }
        .hub-btn { text-decoration: none; padding: 8px 15px; border-radius: 3px; font-weight: bold; color: white; font-size: 13px; transition: 0.2s; }
        .btn-he { background: var(--bosch-blue); } .btn-uno { background: var(--bosch-green); } .btn-agie { background: #525f6b; }
        .hub-btn:hover { opacity: 0.8; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; padding: 20px; flex: 1; overflow: hidden; }
        .col { background: #fdfdfd; border-radius: 5px; display: flex; flex-direction: column; border-top: 8px solid #ccc; box-shadow: 0 4px 10px rgba(0,0,0,0.06); }
        .col-header { padding: 12px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .col-content { padding: 12px; overflow-y: auto; flex: 1; }
        .card { background: white; border: 1px solid #ddd; padding: 12px; margin-bottom: 10px; border-left: 10px solid #ccc; border-radius: 3px; }
        .card-type { font-size: 10px; font-weight: bold; color: #999; text-transform: uppercase; }
        .card-id { font-size: 17px; font-weight: bold; color: var(--bosch-blue); }
        .card-rest { font-size: 17px; font-weight: 900; float: right; }
        .crit { border-left-color: var(--bosch-dark-red); background: #fff8f8; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .urg { border-left-color: var(--bosch-red); }
        .warn { border-left-color: var(--bosch-orange); }
    </style>
</head>
<body>
    <div class="top-bar">BOSCH W430 MAINTENANCE CONTROL</div>
    <div class="header">
        <div class="bosch-text">BOSCH</div>
        <div class="nav-hub">
            <a class="hub-btn btn-agie" href="agie.html">‚ö° Agie</a>
            <a class="hub-btn btn-uno" href="unotron.html">üß™ Unotron</a>
            <a class="hub-btn btn-he" href="he.html">‚öôÔ∏è HE</a>
        </div>
    </div>
    <div class="grid">
        <div class="col" style="border-top-color: var(--bosch-dark-red)"><div class="col-header" style="color:var(--bosch-dark-red)">√úBERF√ÑLLIG <span id="c1">0</span></div><div id="l1" class="col-content"></div></div>
        <div class="col" style="border-top-color: var(--bosch-red)"><div class="col-header" style="color:var(--bosch-red)">KRITISCH <span id="c2">0</span></div><div id="l2" class="col-content"></div></div>
        <div class="col" style="border-top-color: var(--bosch-orange)"><div class="col-header" style="color:var(--bosch-orange)">WARNUNG <span id="c3">0</span></div><div id="l3" class="col-content"></div></div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg",
            authDomain: "bosch-agie-wartung.firebaseapp.com",
            databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bosch-agie-wartung",
            storageBucket: "bosch-agie-wartung.firebasestorage.app",
            messagingSenderId: "211606405555",
            appId: "1:211606405555:web:cc2475ca47804086a3cbc6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const INT = 156000, UNO = [2000, 4000, 10000, 14000, 18000, 26000, 28000, 30000, 34000, 42000, 50000, 56000, 58000, 66000, 74000, 82000, 90000, 98000, 104000];

        async function load() {
            let list = [];
            const [sA, sH, sU] = await Promise.all([
                db.ref('maintenanceState').once('value'),
                db.ref('maintenanceStateHE').once('value'),
                db.ref('maintenanceStateUnotron').once('value')
            ]);
            
            const process = (snap, type, interval) => {
                const d = snap.val() || {};
                (d.cloudRawData || []).forEach(m => {
                    const id = m.StationNo || m.STATIONNO;
                    const ist = (parseInt(m.Parts || m.PARTS || m['COUNT(*)']) || 0) + ((d.manualOffsets || {})[id] || 0);
                    const c = (d.extraCycles || {})[id] || 0;
                    let target, prev = 0;
                    if(Array.isArray(interval)) { 
                        prev = c > 0 ? interval[c-1] : 0; target = interval[c] || 104000; 
                    } else { 
                        target = (c + 1) * interval; prev = c * interval; 
                    }
                    const rest = target - ist;
                    const perc = (rest / (target - prev)) * 100;
                    if(rest <= 0) list.push({t:type, id, r:rest, s:'crit'});
                    else if(perc <= 3.125) list.push({t:type, id, r:rest, s:'urg'});
                    else if(perc <= 12.5) list.push({t:type, id, r:rest, s:'warn'});
                });
            };

            process(sA, '‚ö° Agie', INT);
            process(sH, '‚öôÔ∏è HE', INT);
            process(sU, 'üß™ Unotron', UNO);
            
            let h = {crit:'', urg:'', warn:''}, c = {crit:0, urg:0, warn:0};
            list.sort((a,b) => a.r - b.r).forEach(m => {
                c[m.s]++;
                h[m.s] += `<div class="card ${m.s}"><div class="card-rest">${m.r.toLocaleString()}</div><div class="card-type">${m.t}</div><div class="card-id">#${m.id}</div></div>`;
            });
            ['crit','urg','warn'].forEach((s, i) => {
                document.getElementById('l'+(i+1)).innerHTML = h[s];
                document.getElementById('c'+(i+1)).innerText = c[s];
            });
        }
        load(); setInterval(load, 30000);
    </script>
</body>
</html>
