<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Unotron Wartung - Bosch V1.3</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root { --bosch-red: #d50000; --bosch-blue: #003a6c; --bosch-green: #008a4f; --bosch-gray: #eff1f2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header & Navigation */
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .bosch-logo { color: var(--bosch-red); font-weight: 900; font-size: 24px; letter-spacing: -1px; }
        
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar Liste */
        .sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .machine-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* Karten-Design */
        .card { background: white; border: 1px solid #eee; border-left: 6px solid #ccc; margin-bottom: 10px; padding: 12px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .m-name { font-weight: bold; font-size: 1.1em; }
        .m-rest { font-weight: bold; }
        .card-details { font-size: 0.85em; color: #666; margin-bottom: 8px; }
        
        /* Buttons & Controls */
        .nav-btn { padding: 6px 12px; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 3px; font-size: 0.9em; }
        .nav-btn:hover { background: #f0f0f0; }
        .btn-primary { background: var(--bosch-blue); color: white; border: none; }
        .cycle-control { display: flex; align-items: center; gap: 8px; font-size: 0.85em; }

        /* Chart Bereich */
        .content { flex: 1; padding: 20px; position: relative; }
        .chart-container { background: white; height: 100%; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <div class="bosch-logo">BOSCH</div>
        <div style="font-weight: bold; color: #555;">Unotron Wartungs√ºbersicht</div>
    </div>
    <div class="controls">
        <button class="nav-btn" onclick="location.href='index.html'">üè† Dashboard</button>
        <button class="nav-btn btn-primary" onclick="copyData()">üìã Liste kopieren</button>
    </div>
</header>

<div class="main-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <strong>Maschinenliste</strong>
            <span id="machineCount" style="background:var(--bosch-blue); color:white; padding:2px 8px; border-radius:10px; font-size:0.8em;">0</span>
        </div>
        <div class="machine-list" id="machineList">
            </div>
    </div>
    
    <div class="content">
        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg", 
        authDomain: "bosch-agie-wartung.firebaseapp.com", 
        databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "bosch-agie-wartung" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const UNO_STEPS = [
        {total:2000},{total:4000},{total:10000},{total:14000},{total:18000},{total:26000},
        {total:28000},{total:30000},{total:34000},{total:42000},{total:50000},{total:56000},
        {total:58000},{total:66000},{total:74000},{total:82000},{total:90000},{total:98000},{total:104000}
    ];

    let state = { cloudRawData: [], extraCycles: {}, config: {} };

    // Daten-Sync
    db.ref('maintenanceStateUnotron').on('value', s => {
        const val = s.val() || {};
        state.cloudRawData = val.cloudRawData || [];
        state.extraCycles = val.extraCycles || {};
        updateUI();
    });

    function updateUI() {
        if (!state.cloudRawData.length) return;

        const data = state.cloudRawData.map(item => {
            const id = item.STATIONNO;
            const ist = parseInt(item["COUNT(*)"] || 0);
            const cIdx = state.extraCycles[id] || 0;
            const target = UNO_STEPS[cIdx]?.total || (104000 + ((cIdx - 18) * 5000));
            const rest = target - ist;

            // Logik: 1/3 der Agie-Werte (666 Warnung, 166 Kritisch)
            let color = "#008a4f"; // Gr√ºn
            if (rest <= 0) color = "#8b0000";       // Dunkelrot
            else if (rest < 166) color = "#d50000"; // Rot
            else if (rest < 666) color = "#ffa500"; // Gelb

            return { id, ist, target, rest, color, cIdx };
        }).sort((a, b) => a.rest - b.rest);

        document.getElementById('machineCount').innerText = data.length;
        const list = document.getElementById('machineList');
        
        list.innerHTML = data.map(d => `
            <div class="card" style="border-left-color:${d.color}">
                <div class="card-header">
                    <span class="m-name">U${d.id}</span>
                    <span class="m-rest" style="color:${d.color}">${d.rest.toLocaleString()}</span>
                </div>
                <div class="card-details">Ziel: ${d.target.toLocaleString()} | Ist: ${d.ist.toLocaleString()}</div>
                <div class="cycle-control">
                    <span>Zyklus:</span>
                    <button class="nav-btn" onclick="changeCycle('${d.id}', -1)">-</button>
                    <span style="min-width:15px; font-weight:bold;">${d.cIdx}</span>
                    <button class="nav-btn" onclick="changeCycle('${d.id}', 1)">+</button>
                </div>
            </div>`).join('');

        renderChart(data);
    }

    async function changeCycle(id, val) {
        const current = state.extraCycles[id] || 0;
        await db.ref(`maintenanceStateUnotron/extraCycles/${id}`).set(Math.max(0, current + val));
    }

    function renderChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (window.myChart) window.myChart.destroy();

        window.myChart = new Chart(ctx, {
            type: 'bar',
            plugins: [ChartDataLabels],
            data: {
                labels: data.map(d => "U" + d.id),
                datasets: [{
                    data: data.map(d => d.rest),
                    backgroundColor: data.map(d => d.color),
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        formatter: v => v.toLocaleString(),
                        font: { weight: 'bold' }
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // Verbesserte Kopierfunktion
    function copyData() {
        const rows = state.cloudRawData.map(item => {
            const id = item.STATIONNO;
            const ist = parseInt(item["COUNT(*)"] || 0);
            const cIdx = state.extraCycles[id] || 0;
            const target = UNO_STEPS[cIdx]?.total || (104000 + ((cIdx - 18) * 5000));
            const rest = target - ist;
            
            // Nur f√§llige oder bald f√§llige ( < 666) kopieren
            if (rest < 666) {
                return `U${id}: noch ${rest.toLocaleString()} St√ºck`;
            }
            return null;
        }).filter(r => r !== null);

        if (rows.length === 0) {
            alert("Keine f√§lligen Maschinen zum Kopieren gefunden.");
            return;
        }

        const text = "F√§llige Unotron Wartungen:\n" + rows.join("\n");
        navigator.clipboard.writeText(text).then(() => {
            alert("Liste der f√§lligen Maschinen kopiert!");
        });
    }
</script>
</body>
</html>
