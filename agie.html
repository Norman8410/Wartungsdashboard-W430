<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Agie Wartung - Bosch</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root { --bosch-red: #d50000; --bosch-blue: #003a6c; --bosch-green: #008a4f; --bosch-gray: #eff1f2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .bosch-logo { color: var(--bosch-red); font-weight: 900; font-size: 24px; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 320px; background: white; border-right: 1px solid #ddd; overflow-y: auto; padding: 10px; }
        .card { background: white; border: 1px solid #eee; border-left: 6px solid #ccc; margin-bottom: 10px; padding: 12px; border-radius: 4px; }
        .content { flex: 1; padding: 20px; }
        .nav-btn { padding: 6px 12px; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 3px; font-weight: bold; color: var(--bosch-blue); }
    </style>
</head>
<body onmousedown="if(window.opener && window.opener.resetInactivityTimer) window.opener.resetInactivityTimer()" 
      onkeydown="if(window.opener && window.opener.resetInactivityTimer) window.opener.resetInactivityTimer()">

<header>
    <div style="display:flex; align-items:center; gap:15px;">
        <div class="bosch-logo">BOSCH</div>
        <div style="font-weight:bold; color:#555;">Agie Wartungs√ºbersicht</div>
    </div>
    <button class="nav-btn" onclick="window.close()">‚ùå Fenster schlie√üen</button>
</header>

<div class="main-container">
    <div class="sidebar" id="machineList"></div>
    <div class="content">
        <canvas id="mainChart"></canvas>
    </div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg", 
        authDomain: "bosch-agie-wartung.firebaseapp.com", 
        databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "bosch-agie-wartung" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();

    const AGIE_PKGS = ["P1/2", "P1/3", "P1/2", "P1/4", "P1/2/3", "P1/5", "P1/2", "P1/3", "P1/2", "P1/4", "P1/2/3", "P1/6/7", "P1/2"];
    let state = { cloudRawData: [], extraCycles: {}, agieOffsets: {} };

    // Audit Log Funktion
    async function writeLog(action, machine, detail) {
        const user = auth.currentUser ? auth.currentUser.email : "Unbekannt";
        await db.ref('auditLog').push({ timestamp: new Date().toISOString(), user, action, machine, detail });
    }

    // WICHTIG: Nur schlie√üen wenn User ausgeloggt wird
    auth.onAuthStateChanged(user => {
        if(!user) {
            console.log("Logout erkannt - schlie√üe Fenster.");
            window.close();
        }
    });

    // Daten laden
    db.ref('maintenanceState').on('value', s => {
        const val = s.val() || {};
        state.cloudRawData = val.cloudRawData || [];
        state.extraCycles = val.extraCycles || {};
        state.agieOffsets = val.agieOffsets || {};
        updateUI();
    });

    function updateUI() {
        if (!state.cloudRawData.length) return;
        const data = state.cloudRawData.map(item => {
            const id = item.StationNo;
            const ist = (parseInt(item.Parts) || 0) - (state.agieOffsets[id] || 0);
            const cIdx = state.extraCycles[id] || 0;
            const target = 16000 + (cIdx * 16000);
            const rest = target - ist;
            const color = rest <= 0 ? "#8b0000" : (rest < 500 ? "#d50000" : (rest < 2000 ? "#ffa500" : "#008a4f"));
            return { id, ist, target, rest, color, cIdx };
        }).sort((a,b) => a.rest - b.rest);

        document.getElementById('machineList').innerHTML = data.map(d => `
            <div class="card" style="border-left-color:${d.color}">
                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>A${d.id}</span>
                    <span style="color:${d.color}">${d.rest.toLocaleString()}</span>
                </div>
                <span style="font-size:0.85em; color:var(--bosch-red); font-weight:bold; display:block; margin: 4px 0;">Paket: ${AGIE_PKGS[Math.min(d.cIdx, AGIE_PKGS.length-1)]}</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="nav-btn" onclick="changeCycle('${d.id}', -1)">-</button>
                    <b>${d.cIdx}</b>
                    <button class="nav-btn" onclick="changeCycle('${d.id}', 1)">+</button>
                    <button class="nav-btn" style="font-size:0.8em; margin-left:auto;" onclick="wpReset('${d.id}')">üîÑ Reset</button>
                </div>
            </div>`).join('');
        renderChart(data);
    }

    async function changeCycle(id, val) {
        const current = state.extraCycles[id] || 0;
        const newVal = Math.max(0, current + val);
        await db.ref(`maintenanceState/extraCycles/${id}`).set(newVal);
        writeLog("Zyklus √Ñnderung", "A"+id, `Von ${current} auf ${newVal}`);
    }

    async function wpReset(id) {
        const configSnap = await db.ref('config').once('value');
        if(prompt("Admin Passwort f√ºr Full-Service-Reset (208k):") === configSnap.val()?.AdminPW) {
            const newOffset = (state.agieOffsets[id] || 0) + 208000;
            await db.ref(`maintenanceState/agieOffsets/${id}`).set(newOffset);
            await db.ref(`maintenanceState/extraCycles/${id}`).set(0);
            writeLog("Full Reset", "A"+id, `Offset erh√∂ht auf ${newOffset}`);
            alert("Reset durchgef√ºhrt!");
        } else { alert("Passwort falsch!"); }
    }

    function renderChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
            type: 'bar', plugins: [ChartDataLabels],
            data: { 
                labels: data.map(d => "A"+d.id), 
                datasets: [{ data: data.map(d => d.rest), backgroundColor: data.map(d => d.color) }] 
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: {display:false}, datalabels: {anchor:'end', align:'top', formatter:v=>v.toLocaleString()} } 
            }
        });
    }
</script>
</body>
</html>
